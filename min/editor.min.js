ZenPen=window.ZenPen||{},ZenPen.editor=function(){function e(){P=!1,n();var e=document.createRange(),o=window.getSelection();e.setStart(C,1),o.removeAllRanges(),o.addRange(e),t(),ZenPen.util.supportsHtmlStorage()&&d()}function t(){document.onkeyup=ZenPen.util.supportsHtmlStorage()?function(e){o(e),s()}:o,document.onmousedown=o,document.onmouseup=function(e){setTimeout(function(){o(e)},1)},window.addEventListener("resize",function(){c()}),document.body.addEventListener("scroll",function(){c()}),document.addEventListener("compositionstart",x),document.addEventListener("compositionend",y)}function n(){C=document.querySelector(".header"),q=document.querySelector(".content"),h=document.querySelector(".text-options"),T=h.querySelector(".options"),b=h.querySelector(".bold"),b.onclick=r,R=h.querySelector(".italic"),R.onclick=m,A=h.querySelector(".quote"),A.onclick=f,E=h.querySelector(".url"),E.onmousedown=p,B=h.querySelector(".url-input"),B.onblur=S,B.onkeydown=g}function o(e){var t=window.getSelection();return"url-input"===e.target.className||e.target.classList.contains("url")||e.target.parentNode.classList.contains("ui-inputs")?(k=u(t.focusNode),i(),void 0):(t.isCollapsed===!0&&L===!1&&a(),t.isCollapsed===!1&&P===!1&&(k=u(t.focusNode),l(k,"ARTICLE")&&(i(),c(),h.className="text-options active")),L=t.isCollapsed,void 0)}function c(){var e=window.getSelection(),t=e.getRangeAt(0),n=t.getBoundingClientRect();h.style.top=n.top-5+window.pageYOffset-175+"px",h.style.left="50%"}function i(){b.className=l(k,"B")?"bold active":"bold",R.className=l(k,"I")?"italic active":"italic",A.className=l(k,"BLOCKQUOTE")?"quote active":"quote",E.className=l(k,"A")?"url useicons active":"url useicons"}function a(){h.className="text-options fade",setTimeout(function(){"text-options fade"==h.className&&(h.className="text-options",h.style.top="-999px",h.style.left="-999px")},260)}function u(e){var t={};for(window.getSelection();e.parentNode;)t[e.nodeName]=!0,e=e.parentNode,"A"===e.nodeName&&(t.url=e.href);return t}function l(e,t){return!!e[t]}function s(){localStorage.header=C.innerHTML,localStorage.content=q.innerHTML}function d(){localStorage.header,localStorage.content}function r(){document.execCommand("bold",!1)}function m(){document.execCommand("italic",!1)}function f(){var e=u(window.getSelection().focusNode);l(e,"BLOCKQUOTE")?(document.execCommand("formatBlock",!1,"p"),document.execCommand("outdent")):document.execCommand("formatBlock",!1,"blockquote")}function p(){"options"==T.className?(T.className="options url-mode",setTimeout(function(){var e=u(window.getSelection().focusNode);l(e,"A")?B.value=e.url:document.execCommand("createLink",!1,"/"),lastSelection=window.getSelection().getRangeAt(0),L=!1,B.focus()},100)):T.className="options"}function g(e){13===e.keyCode&&(e.preventDefault(),w(B.value),B.blur())}function S(){T.className="options",w(B.value),B.value="",k=u(window.getSelection().focusNode),i()}function w(e){v(),document.execCommand("unlink",!1),""!==e&&(e.match("^(http|https)://")||(e="http://"+e),document.execCommand("createLink",!1,e))}function v(){window.getSelection().addRange(lastSelection)}function N(){var e=ZenPen.util.getText(q);return""===e?0:e.split(/\s+/).length}function x(){P=!0}function y(){P=!1}var C,q,L,k,h,T,b,R,A,E,B,P;return{init:e,saveState:s,getWordCount:N}}();